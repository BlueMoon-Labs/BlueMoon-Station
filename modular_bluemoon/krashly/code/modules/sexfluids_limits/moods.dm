// ░░░░░░░░░░░░▄▄▄▄░░░░░░░░░░░░░░░░░░░░░░░▄▄▄▄▄
// ░░░█░░░░▄▀█▀▀▄░░▀▀▀▄░░░░▐█░░░░░░░░░▄▀█▀▀▄░░░▀█▄
// ░░█░░░░▀░▐▌░░▐▌░░░░░▀░░░▐█░░░░░░░░▀░▐▌░░▐▌░░░░█▀
// ░▐▌░░░░░░░▀▄▄▀░░░░░░░░░░▐█▄▄░░░░░░░░░▀▄▄▀░░░░░▐▌
// ░█░░░░░░░░░░░░░░░░░░░░░░░░░▀█░░░░░░░░░░░░░░░░░░█

// ⠄⠄⣿⣿⣿⣿⠘⡿⢛⣿⣿⣿⣿⣿⣧⢻⣿⣿⠃⠸⣿⣿⣿⠄⠄⠄⠄⠄
// ⠄⠄⣿⣿⣿⣿⢀⠼⣛⣛⣭⢭⣟⣛⣛⣛⠿⠿⢆⡠⢿⣿⣿⠄⠄⠄⠄⠄
// ⠄⠄⠸⣿⣿⢣⢶⣟⣿⣖⣿⣷⣻⣮⡿⣽⣿⣻⣖⣶⣤⣭⡉⠄⠄⠄⠄⠄
// ⠄⠄⠄⢹⠣⣛⣣⣭⣭⣭⣁⡛⠻⢽⣿⣿⣿⣿⢻⣿⣿⣿⣽⡧⡄⠄⠄⠄
// ⠄⠄⠄⠄⣼⣿⣿⣿⣿⣿⣿⣿⣿⣶⣌⡛⢿⣽⢘⣿⣷⣿⡻⠏⣛⣀⠄⠄
// ⠄⠄⠄⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⠙⡅⣿⠚⣡⣴⣿⣿⣿⡆⠄
// ⠄⠄⣰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⠄⣱⣾⣿⣿⣿⣿⣿⣿⠄
// ⠄⢀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢸⣿⣿⣿⣿⣿⣿⣿⣿⠄
// ⠄⣸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠣⣿⣿⣿⣿⣿⣿⣿⣿⣿⠄
// ⠄⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠛⠑⣿⣮⣝⣛⠿⠿⣿⣿⣿⣿⠄
// ⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⠄⠄⠄⠄⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⠄

// ⠄⠄⠄⠄⠄⡇⠄⠄⠄⠄⠄⢠⡀⠄⠄⢀⡬⠛⠁⠄⠄⠄⠄⠄⠄⠄⠉⠻⣿⣿⣿⣽⣿⣿⣿⣿⣿⣿⣿⣿⣧⠄⠄⠙⢦
// ⠄⠄⠄⠄⠄⡇⠄⠄⠄⠄⢰⠼⠙⢀⡴⠋⠄⠄⠄⠄⠄⠄⠄⠄⠄⡠⠖⠄⠄⠙⠿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣯⣀⡀⠄⠄⠄⡀
// ⠄⠄⠄⠄⠄⡇⠄⠄⠄⠄⠄⠄⡴⠋⠄⠄⠄⠄⠄⠄⠄⠄⠄⢠⠞⠄⠄⠄⠄⠄⠄⠄⠄⠄⠉⠉⠉⠙⠋⠙⠋⠙⠻⠦⠤⣤⣼⣆⣀⣀⣀⣀⡀
// ⠄⠄⠄⠄⠄⢷⠄⠄⠄⠄⢠⠞⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⡰⠃⡄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠉⠉⠉
// ⠄⠄⠄⠄⠄⢸⡀⠄⠄⢠⠏⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣰⠁⣸⠁⠄⠄⠄⠄⠄⠄⠄⠄⢀⠄⠄⡄
// ⠄⠄⠄⠄⠄⢀⣧⠄⢠⠏⠄⠄⠄⠄⠄⠄⠄⠄⠄⢀⢾⠃⡜⡿⠄⠄⠄⠄⠄⠄⠄⠄⣠⠋⢀⣼⠁⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠸⢾⣀⣠
// ⠄⠄⠄⢀⣠⢌⣦⢀⡏⠄⡄⠄⠄⢠⠃⠄⠄⠐⣶⡁⡞⡼⠄⣇⠄⠄⠄⠄⠄⠄⠄⡴⠁⢠⠎⢸⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢈⠝⠁
// ⠄⢀⠞⠉⠄⠄⠹⡼⠄⣼⠁⠄⠄⡏⠄⠄⢀⡞⠄⠈⣷⠇⠄⢻⠄⠄⠄⠄⠄⢐⣞⣀⣰⣃⣀⣸⠄⢀⠇⠄⠄⠄⠄⠄⠄⠄⠄⠄⠁⠄⠄⠄⠄⠄⢀
// ⢰⠋⠄⠄⠄⠄⢀⡇⢠⡏⠄⠄⢸⠄⠄⢀⠎⠄⠄⠄⡇⠄⠄⢸⡀⠄⠄⠄⢠⢾⢁⡜⠁⠄⠄⢸⠄⣸⠄⠄⠄⠄⠄⠄⡀⠄⠄⠄⠄⠄⠄⠄⢀⡴⠃
// ⡞⠄⠄⠄⠄⠄⢸⠄⡞⡷⠄⠄⡟⠄⢘⡟⠛⠷⠶⣤⣅⠄⠄⠄⣇⠄⠄⢠⠋⡧⠊⠄⠄⠄⠄⢸⢀⠇⠄⠄⠄⠄⠄⢰⠁⠄⠄⠄⠄⠄⢀⡴⠋
// ⢹⠄⠄⠄⠄⠄⡾⢰⠃⡇⠄⠄⡇⠄⡜⢀⣠⣤⠶⠞⠛⠁⠄⠄⠘⡄⡰⠃⠘⠱⣾⣟⡛⠛⠛⠛⡟⠂⠄⠄⠄⠄⠄⡎⠄⠄⠄⠄⣀⠴⡋
// ⠈⢳⠄⠄⠄⠄⡇⡼⠄⢻⠄⢠⡇⢸⠁⠈⠁⠄⠄⠄⠄⠄⠄⠄⠄⠈⠁⠄⠄⠄⠄⠙⠿⣶⣄⡰⠇⠄⠄⠄⠄⠄⡼⠄⠄⠄⡠⢾⣿⣆⢳
// ⣀⣬⠿⠷⠦⠤⣷⣇⡠⠾⡄⢸⣇⢸⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢹⠛⠂⠄⠄⠄⠄⣰⠁⠄⣀⣬⣷⠞⠛⠙⠛⢧⣤⣀
// ⠉⠄⠄⠄⠄⠄⢻⠄⠄⠄⢧⢸⢸⠘⡇⠄⠄⠄⠄⠄⠄⠄⠄⣠⠄⠄⠄⠄⠄⠄⠄⠄⠄⢠⠃⠄⠄⠄⠄⠄⣰⠃⣶⢉⠜⠋⠄⠄⠄⠄⠄⠄⠄⠈⢳
// ⠄⠄⠄⢀⣤⡀⢸⠄⠄⠄⠈⢿⠄⠄⣿⣆⠄⠄⠄⠄⠄⠄⠄⡟⣧⠄⠄⠄⠄⠄⠄⠄⡴⠃⠄⠄⠄⡠⠊⡰⡗⠋⡰⡼⠃⠄⠄⠄⠄⠄⠄⠄⠄⠄⢨
// ⠄⢀⡔⠉⠄⠙⢦⠄⠄⠄⠄⢸⡀⢰⡏⠈⠳⣄⠄⠄⠄⠄⠄⠉⠁⠄⠄⠄⠄⠄⢀⡞⠁⠄⢀⣤⠎⠄⡔⣡⠃⢰⡇⣹⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢼
// ⣰⠋⠄⢀⣴⣖⠒⠓⡆⠄⠄⠈⣇⣿⣿⠄⢸⠹⡷⢄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣠⠋⠄⢀⣴⣿⠏⠠⠊⣴⡏⢠⢻⡇⢹⡆⠄⠄⠄⠄⠄⣷⠄⠄⣰⠋
// ⡇⠄⣰⣿⣿⣿⠒⠋⣛⣄⠄⠄⣹⢸⠈⢧⠸⡄⠹⣄⠙⠶⢶⣶⣶⣶⣶⡶⢾⠃⠄⡴⢋⡾⠋⣀⡴⣞⡝⡰⠃⠄⡇⡸⠉⠳⣄⣀⣀⣀⣿⣦⠞⠁
// ⢷⢰⣿⣿⣿⣿⠄⠈⠁⠈⡇⠄⡏⢸⠄⠈⠓⢧⣀⣈⣤⡤⠖⠛⠉⠁⠄⢡⠃⢠⡞⠓⠚⠓⠚⣳⡞⠈⠘⠁⠄⠄⢹⡇⠄⠄⠄⠈⠉⠁⠸⣷⣀⣀⣀
// ⢸⣿⣿⣿⣿⣿⠄⣿⣁⠜⠁⢸⡇⢸⣄⣀⡀⠘⢦⡀⠄⠄⠄⠄⠄⠄⢀⠏⡴⡻⠄⠄⠄⠠⣎⠹⡄⠄⢀⣀⣤⣤⣀⠁⠄⠄⠄⠄⠄⠄⠄⠈⢻⣿⣿
// ⢸⣿⣿⣿⣿⣿⡇⢸⠄⠄⢀⡴⡇⠈⡇⠈⣩⠗⠒⣵⠆⠄⠄⠄⠄⠄⢸⡞⢰⠃⢀⠄⣀⡰⠟⠒⠒⡿⠉⠄⠄⠄⠈⠑⣄⠄⠄⠄⠄⠄⠄⠄⠈⢿⣿
// ⣿⣿⣿⣿⣿⣿⣷⠎⠄⢠⠏⠄⠹⣄⢣⢠⠃⠄⠄⢤⠤⠄⠄⠠⠤⢶⡏⠄⡎⢠⠞⠋⠁⠄⠄⠄⣸⠁⠄⠄⠄⠄⠄⠄⠈⣧⠄⠄⠄⠄⠄⠄⠄⠄⠻
// ⣿⣿⣿⣿⣿⣿⣃⡀⢠⠏⠄⠄⠄⠄⣨⠇⠄⣠⠴⠚⠁⠄⠄⠄⠄⠈⡇⢰⠃⠄⠄⠄⠄⠄⠄⢰⠇⠄⠄⠄⠄⠄⠄⠄⠄⢹⡀
// ⣿⣿⣿⣿⣿⡿⢉⣇⡎⠄⠄⠄⠄⢰⠇⠄⢨⠇⠄⠄⠄⠄⠄⠄⠄⠄⠘⢾⡀⠄⠄⠄⠄⠄⠄⡞⢀⠄⠄⠄⠄⠄⠄⠄⠄⢸⡇

// ░░░░░░░░░░░░▄▄▄▄░░░░░░░░░░░░░░░░░░░░░░░▄▄▄▄▄
// ░░░█░░░░▄▀█▀▀▄░░▀▀▀▄░░░░▐█░░░░░░░░░▄▀█▀▀▄░░░▀█▄
// ░░█░░░░▀░▐▌░░▐▌░░░░░▀░░░▐█░░░░░░░░▀░▐▌░░▐▌░░░░█▀
// ░▐▌░░░░░░░▀▄▄▀░░░░░░░░░░▐█▄▄░░░░░░░░░▀▄▄▀░░░░░▐▌
// ░█░░░░░░░░░░░░░░░░░░░░░░░░░▀█░░░░░░░░░░░░░░░░░░█

/datum/mood_event/fluid_spustil // АХАХХАХАХА, СПУСТИЛ!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	mood_change = 3

/datum/mood_event/fluid_spustil/add_effects(param)
	. = ..()
	var/mob/living/carbon/human/owner_mob = owner_mob()
	description = "<span class='nicegreen'>Я чувствую себя свободн[owner_mob.ru_oy_im()] от жидкостей в моем организме.</span>\n"

/datum/mood_event/fluid_imeetsya
	description = "<span class='warning'>Я начинаю чувствовать тяжесть.</span>\n"
	mood_change = -5

/datum/mood_event/fluid_overcharged
	description = "<span class='boldwarning'>Я теку!</span>\n"
	mood_change = -8

/atom/movable/protechka
	name = ""
	vis_flags = VIS_INHERIT_ID|VIS_INHERIT_DIR
	layer = ABOVE_MOB_LAYER
	mouse_opacity = MOUSE_OPACITY_TRANSPARENT
	icon = 'modular_bluemoon/krashly/code/modules/sexfluids_limits/icons/overlay.dmi'
	icon_state = "blank"

/obj/item/organ/genital
	/// Текущее количество жидкости в гениталии.
	var/fluid_volume = 0
	/// Цвет жидкости fluid_id.color
	var/fluid_color = "#000000"

	var/atom/movable/protechka/protechka

	var/icon_state_organ = "blank"

	var/spawned = FALSE // pohuy, kostil
	var/imeetsya = FALSE

/mob/living/carbon
	var/breasts_protechka_examine = null
	var/penis_protechka_examine = null
	var/womb_protechka_examine = null

/obj/item/organ/genital/proc/fluid_add()
	if(!owner)
		return
	if(owner.stat == DEAD)
		return
	if(HAS_TRAIT(owner, TRAIT_FLUID))
		if(!spawned)
			fluid_volume = rand(MIN_FLUID_SPAWN, MAX_FLUID_SPAWN)
			fluid_color = fluid_id.color
			spawned = TRUE
		if(fluid_id != null)
			if(fluid_volume < MAX_FLUID)
				fluid_volume += (fluid_rate*0.05)

/obj/item/organ/genital/proc/get_fluid_number(obj/item/organ/genital/O)
	switch(O.fluid_volume)
		if(OCHEN_BLIZKO_FLUID to INFINITY)
			return OVERDOHUYA
		if(BLIZKO_TO_MAX_FLUID to OCHEN_BLIZKO_FLUID)
			return CHUTKA
		else
			return NETU

/proc/overlay_fluid(mob/living/carbon/owner, obj/item/organ/genital/organ)
	if(HAS_TRAIT(owner, TRAIT_FLUID_TITS))
		if(istype(organ, /obj/item/organ/genital/breasts))
			var/obj/item/organ/genital/breasts/siski = organ
			switch(siski.fluid_volume)
				if(OCHEN_BLIZKO_FLUID to INFINITY)
					siski.icon_state_organ = "breasts_overfluid"
					if(owner.is_chest_exposed())
						owner.breasts_protechka_examine = "<span class='notice'>Грудь <b>[owner]</b> выглядит <b>крайне</b> мокрой!</span>"
						if(prob(20))
							var/obj/effect/decal/cleanable/fluidrip/drip = new(owner.loc)
							drip.color = siski.fluid_color
							drip.reagents.add_reagent(siski.fluid_id, 1)
					else
						owner.breasts_protechka_examine = "<span class='notice'>Одежда <b>[owner]</b> в районе груди выглядит <b>крайне</b> мокрой!</span>"
				if(BLIZKO_TO_MAX_FLUID to OCHEN_BLIZKO_FLUID)
					siski.icon_state_organ = "breasts_fluid"
					if(owner.is_chest_exposed())
						owner.breasts_protechka_examine = "<span class='notice'>Грудь <b>[owner]</b> выглядит чутка мокрой.</span>"
						if(prob(5))
							var/obj/effect/decal/cleanable/fluidrip/drip = new(owner.loc)
							drip.color = siski.fluid_color
							drip.reagents.add_reagent(siski.fluid_id, 1)
					else
						owner.breasts_protechka_examine = "<span class='notice'>Одежда <b>[owner]</b> в районе груди выглядит чутка мокрой.</span>"
				else
					siski.icon_state_organ = "blank"
					owner.breasts_protechka_examine = null

	else if(HAS_TRAIT(owner, TRAIT_FLUID_PENIS))
		if(istype(organ, /obj/item/organ/genital/testicles))
			var/obj/item/organ/genital/testicles/yayca = organ
			switch(yayca.fluid_volume)
				if(OCHEN_BLIZKO_FLUID to INFINITY)
					yayca.icon_state_organ = "penis_overfluid"
					if(owner.is_groin_exposed())
						owner.penis_protechka_examine = "<span class='notice'>Пенис <b>[owner]</b> выглядит <b>крайне</b> мокрым!</span>"
						if(prob(20))
							var/obj/effect/decal/cleanable/fluidrip/drip = new(owner.loc)
							drip.color = yayca.fluid_color
							drip.reagents.add_reagent(yayca.fluid_id, 1)
					else
						owner.penis_protechka_examine = "<span class='notice'>Одежда <b>[owner]</b> в районе паха выглядит <b>крайне</b> мокрой!</span>"
				if(BLIZKO_TO_MAX_FLUID to OCHEN_BLIZKO_FLUID)
					yayca.icon_state_organ = "penis_fluid"
					if(owner.is_chest_exposed())
						owner.penis_protechka_examine = "<span class='notice'>Пенис <b>[owner]</b> выглядит чутка мокрым.</span>"
						if(prob(5))
							var/obj/effect/decal/cleanable/fluidrip/drip = new(owner.loc)
							drip.color = yayca.fluid_color
							drip.reagents.add_reagent(yayca.fluid_id, 1)
					else
						owner.penis_protechka_examine = "<span class='notice'>Одежда <b>[owner]</b> в районе паха выглядит чутка мокрой.</span>"
				else
					yayca.icon_state_organ = "blank"
					owner.penis_protechka_examine = null

	else if(HAS_TRAIT(owner, TRAIT_FLUID_WOMB))
		if(istype(organ, /obj/item/organ/genital/womb))
			var/obj/item/organ/genital/womb/pizda = organ
			switch(pizda.fluid_volume)
				if(OCHEN_BLIZKO_FLUID to INFINITY)
					pizda.icon_state_organ = "vagina_overfluid"
					if(owner.is_groin_exposed())
						owner.womb_protechka_examine = "<span class='notice'>Киска <b>[owner]</b> выглядит <b>крайне</b> мокрой!</span>"
						if(prob(20))
							var/obj/effect/decal/cleanable/fluidrip/drip = new(owner.loc)
							drip.color = pizda.fluid_color
							drip.reagents.add_reagent(pizda.fluid_id, 1)
					else
						owner.womb_protechka_examine = "<span class='notice'>Одежда <b>[owner]</b> в районе паха выглядит <b>крайне</b> мокрой!</span>"
				if(BLIZKO_TO_MAX_FLUID to OCHEN_BLIZKO_FLUID)
					pizda.icon_state_organ = "vagina_fluid"
					if(owner.is_chest_exposed())
						owner.womb_protechka_examine = "<span class='notice'>Киска <b>[owner]</b> выглядит чутка мокрой.</span>"
						if(prob(5))
							var/obj/effect/decal/cleanable/fluidrip/drip = new(owner.loc)
							drip.color = pizda.fluid_color
							drip.reagents.add_reagent(pizda.fluid_id, 1)
					else
						owner.womb_protechka_examine = "<span class='notice'>Одежда <b>[owner]</b> в районе паха выглядит чутка мокрой.</span>"
				else
					pizda.icon_state_organ = "blank"
					owner.womb_protechka_examine = null
	organ.update_icon_blyat()

/obj/item/organ/genital/proc/update_icon_blyat()
	if(imeetsya == FALSE)
		protechka = new(src)
		owner.vis_contents += protechka
		imeetsya = TRUE
	if(get_fluid_number(src) >= 2)
		if(owner.get_item_by_slot(ITEM_SLOT_OCLOTHING))
			if(!owner.is_chest_exposed())
				var/obj/item/organ/genital/breasts/titki = src
				titki.icon_state_organ = "blank"
				protechka.update_appearance()
			if(!owner.is_groin_exposed())
				var/obj/item/organ/genital/testicles/penis = src
				var/obj/item/organ/genital/womb/pilotka = src
				penis.icon_state_organ = "blank"
				pilotka.icon_state_organ = "blank"
				protechka.update_appearance()
		else
			protechka.icon_state = icon_state_organ
			protechka.color = fluid_color
			protechka.update_appearance()
	else
		vis_contents -= protechka
		qdel(protechka)
		imeetsya = FALSE

/datum/component/mood/proc/HandleFluid(mob/living/carbon/L)
	if(!HAS_TRAIT(L, TRAIT_FLUID))
		return
	for(var/obj/item/organ/genital/O in L.internal_organs)
		O.fluid_add()
		overlay_fluid(L, O)
		switch(O.fluid_volume)
			if(OCHEN_BLIZKO_FLUID to INFINITY)
				add_event(null, "fluid", /datum/mood_event/fluid_overcharged)
			if(BLIZKO_TO_MAX_FLUID to OCHEN_BLIZKO_FLUID)
				add_event(null, "fluid", /datum/mood_event/fluid_imeetsya)
			if(SREDNE_FLUID to BLIZKO_TO_MAX_FLUID)
				clear_event(null, "fluid")
			if(MIN_FLUID to SREDNE_FLUID)
				add_event(null, "fluid", /datum/mood_event/fluid_spustil)
